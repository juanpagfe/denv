#!/bin/bash

# Configuration
CONF_DIR="$HOME/.config/aimgr"
mkdir -p "$CONF_DIR"

usage() {
    echo "Usage: aimgr [options]"
    echo "  -i, --install [file]  Install AppImage (optional: path to file)"
    echo "  -u, --uninstall       Remove AppImage"
    echo "  -l, --list            List installed"
    exit 1
}

list_apps() {
    # Check if directory is empty
    if [ -z "$(ls -A "$CONF_DIR" 2>/dev/null)" ]; then
        echo "No apps managed by aimgr."
        return
    fi

    printf "%-25s | %-10s\n" "App Name" "Scope"
    echo "---------------------------------------"
    
    # Using find with -print0 and while read -d '' to handle spaces safely
    find "$CONF_DIR" -maxdepth 1 -name "*.log" -print0 | while IFS= read -r -d '' log_path; do
        log_file=$(basename "$log_path")
        DATA=$(cat "$log_path")
        IFS='|' read -r EXE DS SCOPE <<< "$DATA"
        printf "%-25s | %-10s\n" "${log_file%.log}" "$SCOPE"
    done
}

install_app() {
    local APP_PATH="$1"

    if [[ -z "$APP_PATH" ]]; then
        read -e -p "Path to AppImage: " APP_PATH
    fi

    APP_PATH="${APP_PATH/#\~/$HOME}"

    if [[ ! -f "$APP_PATH" ]]; then 
        echo "Error: File '$APP_PATH' not found!"
        exit 1
    fi

    DEFAULT_NAME=$(basename "$APP_PATH" .AppImage)
    read -p "Enter App Name [$DEFAULT_NAME]: " CUSTOM_NAME
    NAME="${CUSTOM_NAME:-$DEFAULT_NAME}"

    DEFAULT_CAT="Utility"
    read -p "Enter Category [$DEFAULT_CAT]: " CUSTOM_CAT
    CATEGORY="${CUSTOM_CAT:-$DEFAULT_CAT}"

    echo "Select Scope:"
    select scope in "User" "System"; do
        case $scope in
            "User" ) BIN="$HOME/.local/bin"; APP="$HOME/.local/share/applications"; S=""; break;;
            "System" ) BIN="/usr/local/bin"; APP="/usr/share/applications"; S="sudo"; break;;
        esac
    done

    mkdir -p "$BIN" "$APP"
    # Quote the TARGET variable to handle spaces in the name
    TARGET="$BIN/$NAME.AppImage"

    $S cp "$APP_PATH" "$TARGET"
    $S chmod +x "$TARGET"

    DESC="$APP/$NAME.desktop"
    cat <<EOF | $S tee "$DESC" > /dev/null
[Desktop Entry]
Type=Application
Name=$NAME
Exec="$TARGET"
Icon=utilities-terminal
Terminal=false
Categories=$CATEGORY;
EOF

    if [[ "$scope" == "User" ]]; then
        update-desktop-database "$APP" 2>/dev/null
    else
        sudo update-desktop-database "$APP" 2>/dev/null
    fi

    # Crucial: Quote the log filename
    echo "$TARGET|$DESC|$scope" > "$CONF_DIR/$NAME.log"
    echo "Successfully installed $NAME at $(date +%H:%M)."
}

uninstall_app() {
    # Populate a temporary array safely
    local apps=()
    while IFS= read -r -d '' file; do
        apps+=("$(basename "$file")")
    done < <(find "$CONF_DIR" -maxdepth 1 -name "*.log" -print0)

    if [ ${#apps[@]} -eq 0 ]; then
        echo "Nothing to uninstall."
        exit 0
    fi

    echo "Select the app to remove:"
    # Bash select also struggles with spaces in arrays unless handled carefully
    select log in "${apps[@]}"; do
        if [[ -n "$log" ]]; then
            # Quote the file expansion here
            DATA=$(cat "$CONF_DIR/$log")
            IFS='|' read -r EXE DS SCOPE <<< "$DATA"
            
            S_CMD=""
            [[ "$SCOPE" == "System" ]] && S_CMD="sudo"
            
            $S_CMD rm -f "$EXE" "$DS"
            rm "$CONF_DIR/$log"
            echo "Removed ${log%.log}."
            break
        else
            echo "Invalid selection."
        fi
    done
}

case "$1" in
    -i|--install) install_app "$2" ;;
    -u|--uninstall) uninstall_app ;;
    -l|--list) list_apps ;;
    *) usage ;;
esac
